<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ipul War:  RIFT</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      ---blue: #00ffff;
      ---green: #39ff14;
      ---purple: #ff00ff;
      --bg-dark: #0a0a0a;
      --text-color: var(---blue);
    }
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Orbitron', sans-serif;
      background: var(--bg-dark);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
    }
    /* Efek Goyang Layar untuk Nuke */
    .shake {
        animation: shake-animation 0.5s cubic-bezier(.36,.07,.19,.97) both infinite;
        transform: translate3d(0, 0, 0);
        perspective: 1000px;
    }
    @keyframes shake-animation {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
    }


    /* Kontainer utama untuk game dan UI */
    #main-game-wrapper {
      display: flex;
      flex-direction: column; 
      height: 100%;
      width: 100%;
      max-width: calc(100vh * 9 / 16); 
      margin: auto;
      background: #000; 
    }

    /* Area Game */
    #game-area {
      position: relative;
      flex-grow: 1; 
      max-height: 70%; 
      background: #000; 
      border-left: 5px solid #ff00ff; 
      border-right: 5px solid #ff00ff; 
      box-shadow: 0 0 15px var(---blue); 
    }

    canvas {
      background: #000000;
      display: block;
      width: 100%;
      height: 100%;
    }

    /* Penguncian Orientasi Landscape */
    #orientation-warning {
      display: none !important;
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 10;
      color: var(---green);
      text-align: center;
      padding: 20px;
      font-size: 24px;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    @media screen and (orientation: landscape) {
        #main-game-wrapper { display: none !important; }
        #orientation-warning { display: flex !important; }
    }
    @media screen and (orientation: portrait) {
        #main-game-wrapper { display: flex !important; }
        #orientation-warning { display: none !important; }
    }

    /* Area Kontrol */
    #controls-area {
      position: relative;
      flex-shrink: 0; 
      padding: 10px;
      background: var(--bg-dark); 
      border-top: 1px solid var(---blue); 
      box-shadow: 0 -5px 10px rgba(0,255,255,0.3); 
    }

    /* Gaya UI Futuristik/ */
    #ui {
      position: absolute; 
      z-index: 2;
      color: var(--text-color);
      padding: 5px; 
      background: rgba(0, 0, 0, 0.5); 
      backdrop-filter: blur(5px);
      border: 1px solid var(---blue);
      box-shadow: 0 0 10px var(---blue);
      border-radius: 5px;
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      top: 10px; left: 10px;
    }
    
    #controls-panel { 
        position: relative; 
        display: flex;
        flex-direction: row; 
        gap: 10px;
        justify-content: center; 
        align-items: center;
        width: 100%;
        height: 100%;
        box-sizing: border-box; 
    }
    
    .d-pad {
        display: grid;
        grid-template-areas: ". up ." "left center right" ". down .";
        gap: 5px;
        width: 120px; 
        height: 80px;
    }
    .d-pad .btn {
        padding: 0;
        font-size: 18px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .up-btn { grid-area: up; }
    .down-btn { grid-area: down; }
    .left-btn { grid-area: left; }
    .right-btn { grid-area: right; }

    .action-btns {
        display: flex;
        flex-direction: column;
        gap: 5px;
        flex-grow: 1; 
        max-width: 150px;
    }

    .-text {
        text-shadow: 0 0 5px var(--text-color), 0 0 10px var(--text-color);
        animation: -pulse 1.5s infinite alternate;
    }

    .btn {
      font-size: 12px;
      padding: 8px 10px;
      background: rgba(0, 100, 100, 0.7);
      color: var(---blue);
      border: 1px solid var(---blue);
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 0 5px var(---blue);
      font-family: 'Orbitron', sans-serif;
      white-space: nowrap;
    }
    .btn:hover { background: rgba(0, 150, 150, 0.9); box-shadow: 0 0 15px var(---blue); }
    .btn:active { background: var(---blue); color: #000; }
    /* Gaya untuk tombol yang disabled (cooldown) */
    .btn:disabled {
        background: rgba(50, 0, 0, 0.5);
        color: #888;
        border: 1px solid #888;
        box-shadow: none;
        cursor: not-allowed;
    }

    /* Pesan Status Game - PENTING: Z-INDEX 10 AGAR MUNCUL DI ATAS SEMUA ELEMEN */
    #game-over, #victory, #dimension-end {
      position: absolute; 
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 300px;
      padding: 20px;
      text-align: center;
      font-size: 30px;
      display: none;
      background: rgba(0, 0, 0, 0.9); 
      border: 2px solid var(---purple);
      box-shadow: 0 0 20px var(---purple);
      border-radius: 10px;
      color: var(---purple);
      z-index: 10; 
    }
    #subtext { font-size: 16px; }

    #restart, #restart-v, #restart-d {
        position: relative; 
        margin-top: 15px;
    }

    /* Layar Pemilihan Pesawat (PNG) */
    #select-plane {
        position: absolute; 
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 4; 
        text-align: center; 
    }
    #select-plane .plane-select-container {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 15px;
    }
    .plane-btn {
        width: 60px; /* Ukuran Tombol Gambar */
        height: 60px;
        padding: 5px;
        background: rgba(0, 0, 0, 0.7);
        border: 3px solid var(---blue); 
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 0 10px var(---blue);
    }
    .plane-btn img {
        width: 100%;
        height: 100%;
        object-fit: contain; 
        filter: drop-shadow(0 0 5px var(---green)); 
    }
    .plane-btn:hover {
        border-color: var(---green);
        box-shadow: 0 0 20px var(---green);
        transform: scale(1.1);
    }

    /* Transisi Dimensi */
    #dimension-transition {
      position: absolute; 
      top: 0; 
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      opacity: 0;
      color: var(---purple);
      font-size: 48px;
      display: none; 
      align-items: center;
      justify-content: center;
      z-index: 5;
      pointer-events: none;
      text-shadow: 0 0 5px var(---purple), 0 0 10px var(---purple);
      transition: opacity 0.5s ease-in-out; 
      text-align: center; 
    }
    .glitch-active {
        animation: glitch 0.3s infinite;
    }
    @keyframes glitch {
      0% { text-shadow: 2px 0 var(---purple); }
      20% { text-shadow: -2px 0 var(---green); }
      40% { text-shadow: 2px 2px var(---blue); }
      60% { text-shadow: -2px -2px var(---purple); }
      80% { text-shadow: 2px -2px var(---green); }
      100% { text-shadow: 0 0 5px var(---blue); }
    }
  </style>
</head>
<body>
  <div id="orientation-warning">
    <span style="font-size: 60px;">üì≤</span>
    <p>Putar perangkat ke mode **Portrait (9:16)** untuk bermain.</p>
  </div>

  <div id="main-game-wrapper"> 

    <div id="game-area"> 

      <canvas id="gameCanvas"></canvas>

      <div id="dimension-transition" class="-text">DIMENSI LAIN...</div>
      
      <div id="loading-status" class="-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; color: var(---green); z-index: 5;">MEMUAT ASET (0%)...</div>

      <div id="select-plane" style="display: none;">
        <div class="-text" style="font-size: 24px;">PILIH IPUL LU!</div>
        <div class="plane-select-container">
          <button class="plane-btn" onclick="selectPlane('plane')">
            <img src="one.png" alt="Plane 1">
          </button>
          <button class="plane-btn" onclick="selectPlane('rocket')">
            <img src="2.png" alt="Rocket 1">
          </button>
          <button class="plane-btn" onclick="selectPlane('ufo')">
            <img src="3.png" alt="UFO 1">
          </button>
        </div>
      </div>  
      
      <div id="ui">
        <div id="score" class="-text">SCORE: 0</div>
        <div id="bombs-status" class="-text" style="color: var(---purple); font-size: 12px;">DIMENSION RIFT: READY</div>
      </div>  
      
      <div id="game-over" class="-text">
        Bot kali bang
        <div id="subtext">Coba Lagi bot!.</div>
        <button id="restart" class="btn" onclick="location.reload()">RESTART </button>
      </div>  
      <div id="victory" class="-text">
        Keren juga lu ngab
        <div id="subtext"> Keren lu ngab!</div>
        <button id="restart-v" class="btn" onclick="location.reload()">RESTART SISTEM</button>
      </div>  
      <div id="dimension-end" class="-text">
        Geloo keren banget!
        <div id="subtext">Kembali ke garasi IPUL!.</div>
        <button id="restart-d" class="btn" onclick="location.reload()">RESTART SISTEM</button>
      </div>
    </div> 

    <div id="controls-area"> 

      <div id="controls-panel">
        <div class="d-pad">
            <button class="btn up-btn" ontouchstart="setKey('up', true)" ontouchend="setKey('up', false)" onmousedown="setKey('up', true)" onmouseup="setKey('up', false)">‚¨ÜÔ∏è</button>
            <button class="btn left-btn" ontouchstart="setKey('left', true)" ontouchend="setKey('left', false)" onmousedown="setKey('left', true)" onmouseup="setKey('left', false)">‚¨ÖÔ∏è</button>
            <button class="btn right-btn" ontouchstart="setKey('right', true)" ontouchend="setKey('right', false)" onmousedown="setKey('right', true)" onmouseup="setKey('right', false)">‚û°Ô∏è</button>
            <button class="btn down-btn" ontouchstart="setKey('down', true)" ontouchend="setKey('down', false)" onmousedown="setKey('down', true)" onmouseup="setKey('down', false)">‚¨áÔ∏è</button>
        </div>
        
        <div class="action-btns">
          <button class="btn" onclick="useNuke()">NUKE (E)</button>
          <button class="btn" onclick="useBomb()">DIMENSION RIFT (F)</button>
          <button class="btn" onclick="activateMachineGun()">MG (R)</LINE></button>
        </div>
      </div>
    </div> 

  </div> 
  
  <audio id="nuke-sound" src="tukam.mp3" preload="auto"></audio>
  <audio id="shoot-sound" src="kakang.mp3" preload="auto"></audio>
  <audio id="explosion-sound" src="aduh.mp3" preload="auto"></audio>
  <audio id="gameover-sound" src="lose.mp3" preload="auto"></audio>
  <audio id="victory-sound" src="anjay.mp3" preload="auto"></audio>
  <audio id="bgm" src="Ipul.mp3" preload="auto" loop></audio>
  <audio id="mg-sound" src="nyah.mp3" preload="auto" loop></audio>


<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreText = document.getElementById('score');
    const bombStatus = document.getElementById('bombs-status');
    const transitionDiv = document.getElementById('dimension-transition');
    
    // Inisialisasi Audio Elements
    const nukeSound = document.getElementById('nuke-sound'); 
    const shootSound = document.getElementById('shoot-sound'); 
    const explosionSound = document.getElementById('explosion-sound'); 
    const gameoverSound = document.getElementById('gameover-sound'); 
    const victorySound = document.getElementById('victory-sound'); 
    const bgm = document.getElementById('bgm'); 
    const mgSound = document.getElementById('mg-sound'); // INISIALISASI MG SOUND

    const loadingStatus = document.getElementById('loading-status'); 

    // Variabel Game
    let planeType = 'plane';
    const player = { x: 0, y: 0, width: 40, height: 40, speed: 6 }; 
    let bullets = [], enemies = [], obstacles = [], boss = null, bossProjectiles = [];
    let initialBossHP = 1000;
    let bossHP = initialBossHP, score = 0;
    let lastShot = 0;
    let gameOver = false, victory = false, altDimension = false;
    let bombUsed = false;
    let nukeCooldown = false;
    let machineGunActive = false;
    let mgEndTime = 0;
    
    let nukeStartTime = 0; 
    const NUKE_COOLDOWN_DURATION = 30000; // 30 detik
    
    let bossName = "Joancuk"; 
    let altBossName = "SUPER Hanief"; 
    let enemyType = "enemy";
    let bossType = "boss";
    
    let explosionAnimation = false;
    const GAME_WIDTH = 400; 
    const GAME_HEIGHT = 600; 
    const GAME_BOUNDARY_LEFT = 5; 
    const GAME_BOUNDARY_RIGHT = GAME_WIDTH - 5; 

    const WIN_SCORE = 5000; 
    
    const buttonKeys = {
      up: false, down: false, left: false, right: false
    };

    // --- LOGIC PEMUATAN ASSET ---
    const assets = {};
    const assetList = [
{ name: 'plane', src: 'one.png' }, 
        { name: 'rocket', src: '2.png' }, 
        { name: 'ufo', src: '3.png' }, 
        { name: 'enemy', src: '4.png' }, 
        { name: 'boss', src: '5.png' }, 
        { name: 'alien', src: '6.png' }, 
        { name: 'obstacle', src: '7.png' }, 
        { name: 'explosion', src: '8.png' },
    ];
    let assetsToLoad = assetList.length;
    let assetsLoaded = 0;

    function assetLoaded() {
        assetsLoaded++;
        const percent = Math.floor((assetsLoaded / assetsToLoad) * 100);
        loadingStatus.innerText = `MEMUAT ASET (${percent}%)...`;
        
        if (assetsLoaded === assetsToLoad) {
            loadingStatus.style.display = 'none';
            document.getElementById('select-plane').style.display = 'block';
            resizeCanvas(); 
        }
    }

    assetList.forEach(asset => {
        assets[asset.name] = new Image();
        assets[asset.name].crossOrigin = "anonymous"; 
        assets[asset.name].onload = assetLoaded;
        assets[asset.name].onerror = () => {
            console.error(`Gagal memuat aset: ${asset.name} dari ${asset.src}. Mungkin CORS/Firewall.`);
            assetLoaded(); 
        };
        assets[asset.name].src = asset.src;
    });
    // --- END LOGIC PEMUATAN ASSET ---
    
    // Fungsi Pembantu Play Sound
    function playSound(audioElement) {
        if (audioElement) {
            audioElement.currentTime = 0; 
            audioElement.play().catch(e => console.log("Gagal memutar suara:", e));
        }
    }

    function resizeCanvas() {
        canvas.width = GAME_WIDTH;
        canvas.height = GAME_HEIGHT;
        if (document.getElementById('select-plane').style.display === 'block') {
            player.x = GAME_WIDTH / 2 - player.width / 2;
            player.y = GAME_HEIGHT - player.height - 30;
        }
    }

    window.addEventListener('resize', resizeCanvas);
    
    function drawImage(imgName, x, y, width = 40, height = 40) {
      const img = assets[imgName];
      if (img && img.complete) {
        ctx.drawImage(img, x, y, width, height);
      } else {
        let emoji = '';
        if (imgName === 'plane' || imgName === 'rocket' || imgName === 'ufo') emoji = 'üöÄ';
        else if (imgName === 'enemy' || imgName === 'alien') emoji = 'üëæ';
        else if (imgName === 'boss') emoji = 'üêâ';
        else if (imgName === 'obstacle') emoji = 'üõ∞';
        
        ctx.font = `${height}px serif`;
        ctx.fillText(emoji, x, y + height * 0.8);
      }
    }
    
    function drawText(text, x, y, size, color, glowColor) {
        ctx.font = `${size}px 'Orbitron', sans-serif`;
        ctx.textAlign = 'center';
        ctx.fillStyle = color;
        ctx.shadowColor = glowColor;
        ctx.shadowBlur = 10;
        ctx.fillText(text, x, y);
        ctx.shadowBlur = 0; 
    }

    function selectPlane(type) {
      planeType = type;
      document.getElementById('select-plane').style.display = 'none';
      player.x = GAME_WIDTH / 2 - player.width / 2;
      player.y = GAME_HEIGHT - player.height - 30;
      
      bgm.volume = 0.4; // Atur volume
      bgm.play().catch(e => console.log("Gagal memutar BGM:", e)); 
      
      gameLoop(); 
    }

    function spawnEnemy() {
      enemies.push({ x: Math.random() * (GAME_BOUNDARY_RIGHT - GAME_BOUNDARY_LEFT - 40) + GAME_BOUNDARY_LEFT, y: -40, type: enemyType, width: 32, height: 32 });
    }

    function spawnObstacle() {
      obstacles.push({ x: Math.random() * (GAME_BOUNDARY_RIGHT - GAME_BOUNDARY_LEFT - 40) + GAME_BOUNDARY_LEFT, y: -40, width: 32, height: 32 });
    }

    function shootBullet(spread = false) {
      const startX = player.x + player.width / 2;
      
      // HANYA PUTAR SUARA JIKA MG TIDAK AKTIF (Karena MG punya loop sound sendiri)
      if (!machineGunActive) { 
        playSound(shootSound); 
      }


      if (spread) {
        [-0.3, 0, 0.3].forEach(a => {
          bullets.push({
            x: startX,
            y: player.y,
            dx: Math.sin(a) * 8, 
            dy: -Math.cos(a) * 8, 
            color: machineGunActive ? '#39ff14' : '#00ffff'
          });
        });
      } else {
        bullets.push({ x: startX, y: player.y, dx: 0, dy: -8, color: '#00ffff' }); 
      }
    }

    function useBomb() {
      if (bombUsed) return;
      bombUsed = true;
      
      document.getElementById('bombs-status').innerText = "DIMENSION RIFT: ACTIVATING...";
      document.getElementById('bombs-status').style.color = '#ff00ff';

      // --- Fase 1: Transisi Keluar ---
      transitionDiv.style.display = 'flex'; 
      transitionDiv.classList.add('glitch-active');
      transitionDiv.style.opacity = 1; 

      // --- Fase 2: Perubahan Game State (0.5 detik) ---
      setTimeout(() => {
        altDimension = true;
        
        boss = null;
        bullets = [];
        enemies = [];
        obstacles = [];
        initialBossHP = 20000;
        bossHP = initialBossHP;
        
        bossName = altBossName; 
        
        bossType = "alien";
        enemyType = "alien"; 
        
        document.getElementById('bombs-status').innerText = "DIMENSION RIFT: USED";
        document.getElementById('bombs-status').style.color = '#ff0000';
      }, 500); 

      // --- Fase 3: Transisi Masuk Kembali (1 detik) ---
      setTimeout(() => {
        transitionDiv.style.opacity = 0; 
        transitionDiv.classList.remove('glitch-active');

        setTimeout(() => {
             transitionDiv.style.display = 'none'; 
        }, 500); 
      }, 1000); 
    }

    function useNuke() {
        if (nukeCooldown) return;
        
        nukeCooldown = true;
        nukeStartTime = Date.now(); 
        
        playSound(nukeSound); 
        
        const dmg = 3000; 
        
        if (boss) {
            boss.hp -= dmg;
            if (boss.hp <= 0) {
                score += altDimension ? 5000 : 2000;
                explosionEffect(boss.x, boss.y); 
                boss = null; 
                updateScore();
                
                if (score >= WIN_SCORE) {
                   victory = true; 
                   endGame(altDimension ? 'dimension-end' : 'victory'); 
                }
            }
        }
        
        document.body.classList.add('shake');
        
        setTimeout(() => { bullets = []; }, 0);
        setTimeout(() => { enemies = []; }, 0);
        setTimeout(() => { obstacles = []; }, 0);
        
        // Hapus Efek Goyang (1 detik)
        setTimeout(() => {
          document.body.classList.remove('shake');
        }, 1000);
        
        // Cooldown Nuke (30 detik)
        setTimeout(() => nukeCooldown = false, NUKE_COOLDOWN_DURATION); 
    }

    function activateMachineGun() {
      if (machineGunActive) return;
      machineGunActive = true;
      mgEndTime = Date.now() + 10000;
      
      // START MG LOOP SOUND
      mgSound.volume = 0.6;
      mgSound.play().catch(e => console.log("Gagal memutar MG sound:", e));

      const interval = setInterval(() => {
        if (Date.now() > mgEndTime) {
          machineGunActive = false;
          clearInterval(interval);
          bombStatus.innerText = bombUsed ? "DIMENSION RIFT: USED" : "DIMENSION RIFT: READY";
          bombStatus.style.color = bombUsed ? '#ff0000' : '#ff00ff';
          
          // STOP MG LOOP SOUND
          mgSound.pause();
          mgSound.currentTime = 0; 
          
        } else {
          shootBullet(true); 
        }
      }, 100);
    }

    function collision(a, b) {
      const widthA = a.width || 40; 
      const heightA = a.height || 40;
      const widthB = b.width || 32; 
      const heightB = b.height || 32;

      return a.x < b.x + widthB && a.x + widthA > b.x && a.y < b.y + heightB && a.y + heightA > b.y;
    }

    function updateScore() {
      document.getElementById('score').innerText = "SCORE: " + score;
    }

    function endGame(statusDivId) {
      gameOver = true;
      
      bgm.pause(); // MENGHENTIKAN BGM
      bgm.currentTime = 0;
      mgSound.pause(); // PASTIKAN MG SOUND JUGA BERHENTI
      mgSound.currentTime = 0;


      if (statusDivId === 'game-over') {
          playSound(gameoverSound);
      } else if (statusDivId === 'victory' || statusDivId === 'dimension-end') {
          playSound(victorySound); 
      }

      document.getElementById(statusDivId).style.display = 'block'; 
      if (statusDivId === 'game-over') document.getElementById('restart').style.display = 'block';
      if (statusDivId === 'victory') document.getElementById('restart-v').style.display = 'block';
      if (statusDivId === 'dimension-end') document.getElementById('restart-d').style.display = 'block';
    }

    function explosionEffect(x, y) {
      drawImage('explosion', x, y, 48, 48);
    }

    function bossAttack() {
      if (!boss) return;

      if (Math.random() < 0.03) { 
        const bomb = { x: boss.x + boss.width / 2 - 2, y: boss.y + 50, dx: 0, dy: 4, width: 5, height: 20 };
        bossProjectiles.push(bomb);
      }
    }
    
    function handleMovement() {
        if (gameOver || victory) return;
      
        const speed = player.speed;

        if (keys['ArrowLeft'] || keys['a'] || buttonKeys.left) player.x = Math.max(GAME_BOUNDARY_LEFT, player.x - speed);
        if (keys['ArrowRight'] || keys['d'] || buttonKeys.right) player.x = Math.min(GAME_BOUNDARY_RIGHT - player.width, player.x + speed);
        if (keys['ArrowUp'] || keys['w'] || buttonKeys.up) player.y = Math.max(0, player.y - speed);
        if (keys['ArrowDown'] || keys['s'] || buttonKeys.down) player.y = Math.min(GAME_HEIGHT - player.height, player.y + speed);
    }


    // --- MAIN GAME LOOP (requestAnimationFrame) ---
    function gameLoop() {
      if (gameOver || victory) return;
      
      const nukeBtn = document.querySelector('.action-btns .btn:first-child');
      if (nukeCooldown) {
          const timeSinceNuke = Date.now() - nukeStartTime;
          const timeLeft = Math.max(0, Math.ceil((NUKE_COOLDOWN_DURATION - timeSinceNuke) / 1000));
          
          if (nukeBtn) {
              nukeBtn.innerText = `NUKE CD: ${timeLeft}s`;
              nukeBtn.disabled = true;
          }
          
          if (timeLeft === 0) {
              nukeBtn.innerText = `NUKE (E)`;
              nukeBtn.disabled = false;
              nukeCooldown = false; 
              nukeStartTime = 0;
          }
      } else {
           if (nukeBtn && nukeBtn.disabled) {
               nukeBtn.innerText = `NUKE (E)`;
               nukeBtn.disabled = false;
           }
      }


      if (score >= WIN_SCORE && !boss) {
          victory = true; 
          endGame(altDimension ? 'dimension-end' : 'victory'); 
          return; 
      }
      
      handleMovement(); 

      ctx.fillStyle = '#0a0a0a'; 
      ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
      
      drawImage(planeType, player.x, player.y, player.width, player.height);

      if (player.x < GAME_BOUNDARY_LEFT || player.x + player.width > GAME_BOUNDARY_RIGHT) {
          explosionEffect(player.x, player.y);
          endGame('game-over');
          return;
      }

      // Update dan Gambar Peluru
      bullets.forEach((b, i) => {
        ctx.fillStyle = b.color;
        ctx.shadowColor = b.color;
        ctx.shadowBlur = 5;
        ctx.fillRect(b.x, b.y, 4, 10); 
        ctx.shadowBlur = 0; 
        b.x += b.dx;
        b.y += b.dy;
        if (b.y < -20 || b.y > GAME_HEIGHT) bullets.splice(i, 1);
      });

      // Update dan Gambar Musuh
      enemies.forEach((e, i) => {
        drawImage(e.type, e.x, e.y, e.width, e.height);
        e.y += altDimension ? 3 : 2; 
        
        bullets.forEach((b, j) => {
          if (collision(b, e)) {
            bullets.splice(j, 1);
            enemies.splice(i, 1);
            score += 100;
            updateScore();
            explosionEffect(e.x, e.y);
            playSound(explosionSound); 
          }
        });
        if (collision(player, e)) {
          explosionEffect(player.x, player.y);
          endGame('game-over');
        }
      });

      // Update dan Gambar Obstacle
      obstacles.forEach((o, i) => {
        drawImage('obstacle', o.x, o.y, o.width, o.height);
        o.y += 2.5; 
        if (collision(player, o)) endGame('game-over');
      });

      // Spawn Boss Normal
      if (!boss && score >= 1000 && !altDimension && score < WIN_SCORE) {
        initialBossHP = 1000;
        bossHP = initialBossHP;
        boss = { x: GAME_WIDTH / 2 - 50, y: 50, hp: bossHP, width: 80, height: 80 };
      }
      
      // Spawn Boss Dimensi Kedua
      if (altDimension && !boss && score < WIN_SCORE) {
        if (!explosionAnimation) { 
            explosionAnimation = true;
            explosionEffect(GAME_WIDTH / 2 - 32, GAME_HEIGHT / 2 - 32); 
            setTimeout(() => {
              initialBossHP = 20000;
              bossHP = initialBossHP;
              boss = { x: GAME_WIDTH / 2 - 50, y: 50, hp: bossHP, width: 80, height: 80 };
              explosionAnimation = false;
            }, 1000);
        }
      }

      // Logika Boss
      if (boss) {
        if (explosionAnimation) explosionEffect(boss.x + 20, boss.y + 20);

        drawImage(bossType, boss.x, boss.y, boss.width, boss.height);
        const hpBarWidth = 150;
        const hpBarX = boss.x + boss.width / 2 - hpBarWidth / 2;
        const hpBarY = boss.y - 15;
        ctx.fillStyle = '#ff0000';
        ctx.fillRect(hpBarX, hpBarY, hpBarWidth, 5);
        ctx.fillStyle = '#39ff14';
        const currentHPWidth = (boss.hp / initialBossHP) * hpBarWidth;
        ctx.fillRect(hpBarX, hpBarY, currentHPWidth, 5);
        
        drawText(altDimension ? altBossName : bossName, boss.x + boss.width / 2, boss.y - 25, 16, '#ff00ff', '#ff00ff');
        
        boss.x += Math.sin(Date.now() / 300) * 3; 
        
        bossAttack();

        bullets.forEach((b, i) => {
          if (collision(b, boss)) {
            boss.hp -= 10; 
            bullets.splice(i, 1);
            if (boss.hp <= 0) {
              score += altDimension ? 5000 : 2000;
              explosionEffect(boss.x, boss.y);
              boss = null;
              updateScore();
              playSound(explosionSound); 

              if (score >= WIN_SCORE) {
                 victory = true; 
                 endGame(altDimension ? 'dimension-end' : 'victory');
              }
            }
          }
        });
        if (collision(player, boss)) {
            explosionEffect(player.x, player.y);
            endGame('game-over');
        }
      }

      // Logika Proyektil Boss
      bossProjectiles.forEach((bomb, i) => {
        ctx.fillStyle = altDimension ? '#ff0000' : '#ffff00';
        ctx.shadowColor = ctx.fillStyle;
        ctx.shadowBlur = 8;
        ctx.fillRect(bomb.x, bomb.y, bomb.width, bomb.height);
        ctx.shadowBlur = 0;
        bomb.y += bomb.dy;
        bomb.x += bomb.dx;
        
        if (bomb.y > GAME_HEIGHT || bomb.x < 0 || bomb.x > GAME_WIDTH) bossProjectiles.splice(i, 1);
        if (collision(player, bomb)) {
             explosionEffect(player.x, player.y);
             endGame('game-over');
        }
      });

      // Spawn Musuh/Obstacle (jika tidak ada bos)
      if (!boss && score < WIN_SCORE) { 
          if (Math.random() < 0.03) spawnEnemy(); 
          if (Math.random() < 0.02) spawnObstacle(); 
      }

      // Logika Penembakan
      if (!machineGunActive && Date.now() - lastShot > 800) { 
        shootBullet(true);
        lastShot = Date.now();
      }
      
      // Update Status UI (MG & Dimension Rift)
      if (machineGunActive) {
          bombStatus.innerText = `MG ACTIVE: ${Math.max(0, Math.ceil((mgEndTime - Date.now()) / 1000))}s`;
          bombStatus.style.color = '#39ff14';
      } else if (!bombUsed) {
          bombStatus.innerText = "DIMENSION RIFT: READY";
          bombStatus.style.color = '#ff00ff';
      }
      
      requestAnimationFrame(gameLoop);
    }
    
    // Logika Input Keyboard & Gerakan
    const keys = {};
    document.addEventListener('keydown', e => {
      keys[e.key] = true;
      if (e.key === 'f') useBomb();
      if (e.key === 'e') useNuke(); 
      if (e.key === 'r') activateMachineGun();
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' ', 'f', 'r', 'e'].includes(e.key)) {
        e.preventDefault();
      }
    });
    document.addEventListener('keyup', e => keys[e.key] = false);

    // Fungsi untuk mengontrol tombol virtual
    function setKey(dir, isPressed) {
      if (dir === 'up') buttonKeys.up = isPressed;
      if (dir === 'down') buttonKeys.down = isPressed;
      if (dir === 'left') buttonKeys.left = isPressed;
      if (dir === 'right') buttonKeys.right = isPressed;
    }

    updateScore();
  </script>
</body>
</html>
